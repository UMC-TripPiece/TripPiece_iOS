// Copyright ¬© 2024 TripPiece. All rights reserved


import UIKit
import SwiftyToaster

class ColoringVC: UIViewController {
    
    var cityData: SearchedCityResponse? // Î∞õÏïÑÏò¨ ÎèÑÏãú Ï†ïÎ≥¥
    let defaultColors = ["6744FF", "FFB40F", "25CEC1", "FD2D69"]
    var selectedColors: [String] = []

    // MARK: - UI Components
    private let containerView: UIView = {
        let view = UIView()
        view.backgroundColor = .white
        view.layer.cornerRadius = 12
        view.layer.masksToBounds = true
        return view
    }()
    
    // Ïò§Î•∏Ï™Ω ÏúÑ 'X'Ïûê Î≤ÑÌäº
    private let dismissButton: UIButton = {
        let button = UIButton()
        button.setImage(UIImage(systemName: "xmark"), for: .normal)
        button.tintColor = UIColor(named: "Black3")
        button.isUserInteractionEnabled = true
        button.snp.makeConstraints { make in
            make.width.height.equalTo(14)
        }
        return button
    }()
    
    private let countryImage: UIImageView = {
        let imageView = UIImageView()
        imageView.backgroundColor = Constants.Colors.black5
        imageView.contentMode = .scaleAspectFill
        imageView.clipsToBounds = true
        imageView.layer.cornerRadius = 25 // Ïù¥ÎØ∏ÏßÄÎ∑∞Ïùò ÌÅ¨Í∏∞Ïóê ÎßûÏ∂∞ Î∞òÏßÄÎ¶ÑÏùÑ ÏÑ§Ï†ïÌï¥Ïïº Ìï®
        imageView.layer.masksToBounds = true
        return imageView
    }()
    
    private let emojiLabel: UILabel = {
        let label = UILabel()
        label.text = "üòµ"  // ÏõêÌïòÎäî Ïù¥Î™®Ìã∞ÏΩò ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
        label.font = UIFont.systemFont(ofSize: 32) // Î†àÏù¥Î∏îÏùò Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
        label.textAlignment = .center
        return label
    }()
    
    private let titleLabel: UILabel = {
        let label = UILabel()
        label.text = "ÌÅ¥Î¶≠Îêú ÎèÑÏãúÍ∞Ä ÏóÜÏäµÎãàÎã§"
        label.font = UIFont.systemFont(ofSize: 16, weight: .black)
        label.textAlignment = .center
        return label
    }()
    
    private let colorSelectBackgroundView: UIView = {
        let view = UIView()
        view.backgroundColor = UIColor(hex: "#F9F9F9")
        return view
    }()
    
    // ÏÉâÏÉÅ ÏÑ†ÌÉù description label
    private let colorSelectDescriptionStack: UIStackView = {
        let stackView = UIStackView()
        stackView.axis = .vertical
        stackView.spacing = 2
        stackView.alignment = .leading
        
        let firstLabel: UILabel = {
            let label = UILabel()
            label.text = "ÏÉâÏÉÅ ÏÑ†ÌÉù"
            label.font = UIFont.boldSystemFont(ofSize: 16)
            label.textColor = UIColor(hex: "#393939")
            return label
        }()

        let secondLabel: UILabel = {
            let label = UILabel()
            label.text = "ÏÉâÏÉÅÏùÄ ÎÇòÎùº Ï†ÑÏ≤¥Ïóê Î∞òÏòÅÎê©ÎãàÎã§."
            label.font = UIFont.systemFont(ofSize: 12)
            label.textColor = Constants.Colors.black2
            return label
        }()

        stackView.addArrangedSubview(firstLabel)
        stackView.addArrangedSubview(secondLabel)
        
        return stackView
    }()
    
    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏùÑ Ï∂îÏ†ÅÌïòÎäî Î≥ÄÏàò
    public var selectedButton: UIButton? {
        didSet {
            // selectedButtonÏù¥ ÏÑ§Ï†ïÎê† ÎïåÎßàÎã§ saveButtonÏùò ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏
            saveButton.isEnabled = (selectedButton != nil)
        }
    }
    
    public lazy var colorSelectionCollectionView: UICollectionView = {
        let layout = UICollectionViewFlowLayout()
        layout.scrollDirection = .horizontal
        layout.minimumLineSpacing = 10
        layout.minimumInteritemSpacing = 17
        layout.estimatedItemSize = CGSize(width: 54, height: 54) // ÌçºÏ¶ê ÌÅ¨Í∏∞ ÏÑ§Ï†ï
            
        let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
        collectionView.register(ColorPuzzleCell.self, forCellWithReuseIdentifier: ColorPuzzleCell.identifier)
        collectionView.backgroundColor = .clear
        collectionView.isScrollEnabled = true
        collectionView.showsHorizontalScrollIndicator = false
        collectionView.contentInset = UIEdgeInsets(top: 0, left: 13, bottom: 0, right: 13)
        collectionView.dataSource = self
        collectionView.delegate = self
        return collectionView
    }()
    
    let cancelButton: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("Ï∑®ÏÜå", for: .normal)
        button.titleLabel?.font = UIFont.boldSystemFont(ofSize: 16)
        button.backgroundColor = UIColor(hex: "#A4A4A4")?.withAlphaComponent(0.1)
        button.setTitleColor(UIColor(hex: "#636363"), for: .normal)
        button.layer.cornerRadius = 5
        button.layer.masksToBounds = true
        return button
    }()

    private let saveButton: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("Ï†ÄÏû•", for: .normal)
        // ÎπÑÌôúÏÑ±Ìôî ÏÉÅÌÉúÏùº Îïå
        button.setTitleColor(.lightGray, for: .disabled)
        button.titleLabel?.font = UIFont.boldSystemFont(ofSize: 16)
        // ÌôúÏÑ±Ìôî ÏÉÅÌÉúÏùº Îïå
        button.backgroundColor = Constants.Colors.mainPurple
        button.setTitleColor(.white, for: .normal)
        button.layer.cornerRadius = 5
        button.layer.masksToBounds = true
        return button
    }()

    /// Ï∑®ÏÜå/ÏôÑÎ£å Î≤ÑÌäº
    private let buttonsStackView: UIStackView = {
        let stackView = UIStackView()
        stackView.axis = .horizontal
        stackView.spacing = 7
        stackView.distribution = .fillEqually
        return stackView
    }()


    // MARK: - Life Cycle
    override func viewDidLoad() {
        super.viewDidLoad()
        addSubViews()
        setupConstraints()
        setUpColorPicker()
        addTargetToButtons()
        
        view.backgroundColor = UIColor.black.withAlphaComponent(0.4)
        saveButton.isEnabled = false // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú ÎπÑÌôúÏÑ±Ìôî
        
        if let cityData = cityData {
            titleLabel.text = "\(cityData.cityName), \(cityData.countryName)"
            emojiLabel.text = cityData.countryImage
        }
        
        
    }
    
    
    // MARK: - UI Methods
    private func addSubViews() {
        view.addSubview(containerView)
        containerView.addSubview(dismissButton)
        containerView.addSubview(countryImage)
        countryImage.addSubview(emojiLabel)
        containerView.addSubview(titleLabel)
        containerView.addSubview(colorSelectBackgroundView)
        containerView.addSubview(colorSelectDescriptionStack)
        containerView.addSubview(colorSelectionCollectionView)
        containerView.addSubview(buttonsStackView)
        buttonsStackView.addArrangedSubview(cancelButton)
        buttonsStackView.addArrangedSubview(saveButton)
        containerView.addSubview(dismissButton)
    }
    
    private func setupConstraints() {
        let screenSize = UIScreen.main.bounds.size
        // Container view constraints
        containerView.snp.makeConstraints { make in
            make.center.equalToSuperview()
            make.width.equalToSuperview().multipliedBy(0.89230769)
            if screenSize.height >= 812 {
                make.height.equalToSuperview().multipliedBy(0.39454976)
            } else {
                make.height.equalToSuperview().multipliedBy(0.45)
            }
        }
        //dismissButton constraints
        dismissButton.snp.makeConstraints { make in
            make.top.equalToSuperview().offset(15)
            make.trailing.equalToSuperview().offset(-15)
        }
        //country image
        countryImage.snp.makeConstraints { make in
            make.top.equalToSuperview().offset(34)
            make.centerX.equalToSuperview()
            make.height.width.equalTo(51)
        }
        emojiLabel.snp.makeConstraints { make in
            make.center.equalToSuperview()
        }
        // Title label constraints
        titleLabel.snp.makeConstraints { make in
            make.centerX.equalToSuperview()
            make.top.equalTo(countryImage.snp.bottom).offset(10)
        }
        // ÏÉâÍπî ÏÑ†ÌÉù Î∑∞ (ÏàòÏ†ï ÌïÑÏöî)
        colorSelectBackgroundView.snp.makeConstraints { make in
            make.top.equalTo(titleLabel.snp.bottom).offset(17)
            make.bottom.equalTo(buttonsStackView.snp.top).offset(-13)
            make.horizontalEdges.equalToSuperview()
        }
        colorSelectDescriptionStack.snp.makeConstraints { make in
            make.top.equalTo(colorSelectBackgroundView.snp.top).offset(10)
            make.leading.equalToSuperview().inset(13)
        }
        // Color selection view constraints
        colorSelectionCollectionView.snp.makeConstraints { make in
            make.centerX.equalToSuperview()
            make.centerY.equalTo(colorSelectBackgroundView.snp.centerY).multipliedBy(1.1)
            make.horizontalEdges.equalToSuperview().inset(10)
            make.height.equalTo(60)
        }
        // Cancel and done button constraints
        buttonsStackView.snp.makeConstraints { make in
            make.centerX.equalToSuperview()
            make.width.equalToSuperview().multipliedBy(0.945402299)
            make.height.equalToSuperview().multipliedBy(0.12012012)
            make.bottom.equalToSuperview().inset(10)
        }
    }
    
    
    
    //MARK: Setup Actions
    private func setUpColorPicker() {
        // Ï†ÄÏû•Îêú ÏÉâÏÉÅ Î∂àÎü¨Ïò§Í∏∞
        selectedColors = loadSelectedColors()
        colorSelectionCollectionView.reloadData()
        // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ï†úÏä§Ï≤ò Ï∂îÍ∞Ä
        let longPressGesture = UILongPressGestureRecognizer(target: self, action: #selector(handleLongPress(_:)))
        colorSelectionCollectionView.addGestureRecognizer(longPressGesture)
    }
    
    private func addTargetToButtons() {
        dismissButton.addTarget(self, action: #selector(dismissButtonTapped), for: .touchUpInside)
        cancelButton.addTarget(self, action: #selector(cancelButtonTapped(_:)), for: .touchUpInside)
        saveButton.addTarget(self, action: #selector(saveButtonTapped(_:)), for: .touchUpInside)
    }
    
    // Ï∑®ÏÜå Î≤ÑÌäº ÎàåÎ†∏ÏùÑ Îïå
    @objc func cancelButtonTapped(_ sender: UIButton) {
        dismiss(animated: true, completion: nil)
    }
    
    @objc private func dismissButtonTapped(_ sender: UIButton) {    // Î™®Îã¨Î°ú ÌëúÏãúÎêú Î∑∞ Ïª®Ìä∏Î°§Îü¨Î•º Ï†ÑÎ∂Ä Îã´Ïùå
        self.presentingViewController?.presentingViewController?.dismiss(animated: true, completion: nil)
    }
    
    
    func dismissMultipleTimes(from viewController: UIViewController?, completion: @escaping () -> Void) {
        guard let viewController = viewController else {
            completion()
            return
        }
                
        // Îëê Î≤àÏùò dismissÎ•º ÎèôÏãúÏóê Ïã§Ìñâ
        if let firstPresentingViewController = viewController.presentingViewController?.presentingViewController {
            viewController.dismiss(animated: false) // Ï≤´ Î≤àÏß∏ Î∑∞ Îã´Í∏∞
            firstPresentingViewController.dismiss(animated: true, completion: completion) // Îëê Î≤àÏß∏ Î∑∞ Îã´Í∏∞
        } else if let firstPresentingViewController = viewController.presentingViewController {
                viewController.dismiss(animated: true, completion: completion) // Ìïú Î≤àÎßå Îã´Í∏∞
        } else {
            completion()
        }
    }
    
    private func dismissWhenEditing() {
        // ÌòÑÏû¨ ÌôîÎ©¥ÏóêÏÑú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïä§ÌÉù Îã´Í∏∞
        if let navigationController = self.navigationController {
            navigationController.popToRootViewController(animated: false)
                
            navigationController.dismiss(animated: false)
        } else {
            self.presentingViewController?.dismiss(animated: true, completion: nil)
        }
    }




    @objc private func saveButtonTapped(_ sender: UIButton) {        // ÏÑúÎ≤ÑÏóê Ìï¥Îãπ Ïú†Ï†ÄÏùò Í∏∞Î°ùÏùÑ Ïò¨Î¶¥ Í≤É
        guard let selectedColor = selectedButton?.accessibilityIdentifier else { return }
        
        self.getCountryStatsData { [weak self] result in
            guard let self = self else { return }
            guard let data = result else { return }
            guard let cityData = self.cityData else { return }
            
            //ÏàòÏ†ï
            if data.cityIds.contains(cityData.cityId) {
                Toaster.shared.makeToast("ÏÉâÏπ†ÎêòÏóàÎçò ÏÉâÏÉÅÏùÑ ÏàòÏ†ïÌï©ÎãàÎã§.")
                editColor(selectedColor) { editResult in
                    switch editResult {
                    case .success(let message):
                        DispatchQueue.main.async {
                            self.dismissMultipleTimes(from: self) {
                                NotificationCenter.default.post(name: .updateCollectionView, object: nil)
                                NotificationCenter.default.post(name: .changeMapColor, object: nil)
                            }
                        }
                    case .failure(let error):
                        print("ÏÉâÏÉÅ ÏàòÏ†ï Ïò§Î•ò Î∞úÏÉù: \(error.localizedDescription)")
                    }
                }
                // Ï≤´ ÏóÖÎ°úÎìú
            } else {
                colorCountry(selectedColor) { result in
                    switch result {
                    case .success(let message):
                        DispatchQueue.main.async {
                            self.dismissMultipleTimes(from: self) {
                                NotificationCenter.default.post(name: .changeMapColor, object: nil)
                            }
                        }
                    case .failure(let error):
                        print("Ïò§Î•ò Î∞úÏÉù: \(error.localizedDescription)")
                    }
                }
            }
            
        }
    }
        

    //MARK: API call
    func colorCountry(_ color: String, completion: @escaping (Result<Any, Error>) -> Void) {
        guard
            let cityData = cityData,
            let countryCode = CountryEnum.find(byName: cityData.countryName)?.rawValue
        else {
            return
        }

        let data = MapRequest(
            countryCode: "\(countryCode)",
            color: color,  // ÏÑúÎ≤ÑÏóêÏÑú ÏàòÏ†ï ÏôÑÎ£åÎêòÎ©¥ colorÎ°ú ÏàòÏ†ïÌï† Í≤É
            cityId: cityData.cityId
        )

        MapManager.postCountryColor(data) { isSuccess, response in
            if isSuccess {
                completion(.success("Color update successful"))
            } else {
                if let data = response?.data,  // ÏÑúÎ≤Ñ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                   let errorMessage = String(data: data, encoding: .utf8) {
                        print("ÏÑúÎ≤Ñ ÏóêÎü¨ Î©îÏãúÏßÄ: \(errorMessage)")
                }
                        
                let error = NSError(domain: "MapError", code: -1, userInfo: [NSLocalizedDescriptionKey: "Color update failed."])
                completion(.failure(error))
            }
        }
    }
    
    func editColor(_ color: String, completion: @escaping (Result<Any, Error>) -> Void) {
        guard
            let cityData = cityData,
            let countryCode = CountryEnum.find(byName: cityData.countryName)?.rawValue
        else {
            return
        }

        let data = MapRequest(
            countryCode: "\(countryCode)",
            color: color,  // ÏÑúÎ≤ÑÏóêÏÑú ÏàòÏ†ï ÏôÑÎ£åÎêòÎ©¥ colorÎ°ú ÏàòÏ†ïÌï† Í≤É
            cityId: cityData.cityId
        )
        
        MapManager.changeCountryColor(data) { isSuccess, response in
            if isSuccess {
                completion(.success("color change successful"))
            } else {
                if let data = response?.data,  // ÏÑúÎ≤Ñ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                   let errorMessage = String(data: data, encoding: .utf8) {
                        print("ÏÑúÎ≤Ñ ÏóêÎü¨ Î©îÏãúÏßÄ: \(errorMessage)")
                }
                        
                let error = NSError(domain: "MapError", code: -1, userInfo: [NSLocalizedDescriptionKey: "Color update failed."])
                completion(.failure(error))
            }
        }
    }
    
    
    func getCountryStatsData(completion: @escaping (StatsVisitRecord?) -> Void) {
        MapManager.getCountryStats { result in
            switch result {
            case .success(let statsInfo):
                completion(statsInfo.result)
            case .failure(let error):
                print("Ïò§Î•ò Î∞úÏÉù: \(error.localizedDescription)")
                completion(nil)
            }
        }
    }
    
    
}


extension UIImage {
    func resized(to size: CGSize) -> UIImage {
        UIGraphicsBeginImageContextWithOptions(size, false, 0.0)
        self.draw(in: CGRect(origin: .zero, size: size))
        let resizedImage = UIGraphicsGetImageFromCurrentImageContext()
        UIGraphicsEndImageContext()
        return resizedImage ?? self
    }
}




